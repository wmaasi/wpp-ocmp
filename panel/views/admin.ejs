<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de administración</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <link href="/css/output.css" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen flex">

  <!-- Sidebar -->
  <%- include('partials/sidebar') %>

  <!-- Contenido principal -->
  <div class="flex-1 p-6 overflow-x-auto">
    
    <!-- Encabezado -->
 <!-- Indicador + Gráfica -->
<div class="bg-white p-4 rounded-xl shadow-md mb-10">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold text-blue-700">Actividad de mensajes</h2>
    <div id="scorecard" class="text-right">
      <p class="text-sm text-gray-500">Suscriptores activos</p>
      <p class="text-2xl font-bold text-green-600" id="totalActivos">—</p>
    </div>
  </div>
  <canvas id="logChart" height="100"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  fetch('/admin/grafica')
    .then(res => res.json())
    .then(({ labels, datasets, total_activos }) => {
      // Mostrar total de suscriptores activos
      document.getElementById('totalActivos').textContent = total_activos.toLocaleString('es-GT');

      // Renderizar gráfica
      const ctx = document.getElementById('logChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    });

  lucide.createIcons();
</script>


    <!-- Tablas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
      
      <!-- Últimos Suscriptores -->
      <div class="bg-white p-4 rounded-xl shadow-md overflow-x-auto">
        <h2 class="text-lg font-semibold mb-4 text-blue-700">Últimos suscriptores</h2>
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left py-2 px-3">Fecha</th>
              <th class="text-left py-2 px-3">Nombre</th>
              <th class="text-left py-2 px-3">Teléfono</th>
            </tr>
          </thead>
          <tbody>
            <% suscriptores.forEach(s => { %>
              <tr class="border-t hover:bg-blue-50 transition-colors">
                <td class="py-2 px-3">
                  <%= new Date(s.fecha_suscripcion).toLocaleString('es-GT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) %>
                </td>
                <td class="py-2 px-3"><%= s.nombre %></td>
                <td class="py-2 px-3"><%= s.telefono %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Últimos Logs -->
      <div class="bg-white p-4 rounded-xl shadow-md overflow-x-auto">
        <h2 class="text-lg font-semibold mb-4 text-blue-700">Últimos logs</h2>
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left py-2 px-3">Fecha</th>
              <th class="text-left py-2 px-3">Mensaje</th>
              <th class="text-left py-2 px-3">Teléfono</th>
              <th class="text-left py-2 px-3">Estado</th>
            </tr>
          </thead>
          <tbody>
            <% logs.forEach(log => { %>
              <tr class="border-t hover:bg-blue-50 transition-colors">
                <td class="py-2 px-3">
                  <%= new Date(log.fecha).toLocaleString('es-GT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) %>
                </td>
                <td class="py-2 px-3">
  <%= log.mensaje && log.mensaje.length > 20 ? log.mensaje.substring(0, 20) + '…' : log.mensaje %>
</td>
                <td class="py-2 px-3"><%= log.numero %></td>
                <td class="py-2 px-3">
                  <% if (log.estado === 'entregado' || log.estado === 'enviado') { %>
                    <span class="text-green-600 font-semibold"><%= log.estado %></span>
                  <% } else if (log.estado === 'fallido') { %>
                    <span class="text-red-600 font-semibold"><%= log.estado %></span>
                  <% } else { %>
                    <span class="text-yellow-600 font-semibold"><%= log.estado %></span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Programar campaña -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-700 mb-4">Programar campaña por departamento</h2>
      <form action="/admin/campanias" method="POST" class="space-y-4">
        <input type="text" name="titulo" placeholder="Título" required class="w-full border px-3 py-2 rounded">
        <textarea name="mensaje" placeholder="Mensaje a enviar" required class="w-full border px-3 py-2 rounded"></textarea>
        <input type="datetime-local" name="fecha_envio" required class="w-full border px-3 py-2 rounded">
        <select name="departamento" required class="w-full border px-3 py-2 rounded">
          <option value="">Seleccione un departamento</option>
          <option value="Guatemala">Guatemala</option>
          <option value="Quiché">Quiché</option>
          <option value="Huehuetenango">Huehuetenango</option>
          <option value="Chiquimula">Chiquimula</option>
          <option value="Escuintla">Escuintla</option>
          <option value="Petén">Petén</option>
          <!-- puedes agregar más -->
        </select>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Programar</button>
      </form>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  fetch('/admin/grafica')
    .then(res => res.json())
    .then(({ labels, datasets }) => {
      const ctx = document.getElementById('logChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            tooltip: { enabled: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              position: 'left',
              title: { display: true, text: 'Cantidad diaria' }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'Suscriptores acumulados' }
            }
          }
        }
      });
    });

  // Sidebar toggle
  document.getElementById('toggleSidebar').addEventListener('click', () => {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('w-64');
    sidebar.classList.toggle('w-20');
  });

  lucide.createIcons();
</script>

</body>
</html>